<div class="field-mapping">
  @if (serverConfigService.getSelectedId()) {
    <!-- Quick Add from Presets -->
    <mat-card class="presets-card">
      <mat-card-header>
        <mat-card-title>Add Common SCIM Attributes</mat-card-title>
        <button mat-button color="primary" (click)="addCustom()">
          <mat-icon>edit</mat-icon> Custom Attribute
        </button>
      </mat-card-header>
      <mat-card-content>
        @if (availablePresets().length > 0) {
          <div class="preset-chips">
            @for (preset of availablePresets(); track preset.attribute) {
              <button mat-stroked-button class="preset-chip"
                (click)="addFromPreset(preset)"
                [matTooltip]="preset.description">
                <mat-icon class="preset-icon">{{ preset.suggestedFormat === 'email' ? 'email' : preset.suggestedFormat === 'phone' ? 'phone' : 'data_object' }}</mat-icon>
                {{ preset.displayName }}
              </button>
            }
          </div>
        } @else {
          <p class="all-added-msg">All common attributes have been added. Use "Custom Attribute" for others.</p>
        }
      </mat-card-content>
    </mat-card>

    <!-- Discover from Server -->
    <mat-card class="schema-discovery-card">
      <mat-card-header>
        <mat-card-title>Discover from Server</mat-card-title>
        <div class="schema-discovery-actions">
          <button mat-raised-button color="primary"
            (click)="loadSchemaAttributes()"
            [disabled]="loadingSchema()">
            @if (loadingSchema()) {
              <mat-spinner diameter="18"></mat-spinner>
            } @else {
              <mat-icon>{{ schemaLoaded() ? 'refresh' : 'cloud_download' }}</mat-icon>
            }
            {{ schemaLoaded() ? 'Reload' : 'Load from Server' }}
          </button>
          @if (availableDiscovered().length > 0) {
            <button mat-stroked-button color="primary" (click)="addAllDiscovered()"
              [disabled]="loading()"
              matTooltip="Add all discovered attributes as rules">
              <mat-icon>playlist_add</mat-icon>
              Add All ({{ availableDiscovered().length }})
            </button>
          }
        </div>
      </mat-card-header>
      <mat-card-content>
        @if (schemaLoaded() && availableDiscovered().length > 0) {
          <div class="discovered-chips">
            @for (attr of availableDiscovered(); track attr.schema_urn + attr.attr_name) {
              <button mat-stroked-button class="discovered-chip"
                (click)="addFromDiscovered(attr)"
                [matTooltip]="attr.schema_name + ' — ' + attr.attr_type">
                <mat-icon class="disc-icon">schema</mat-icon>
                {{ discoveredDisplayName(attr) }}
                <span class="disc-type-badge">{{ attr.attr_type }}</span>
              </button>
            }
          </div>
        } @else if (schemaLoaded() && availableDiscovered().length === 0 && discoveredAttributes().length > 0) {
          <p class="all-added-msg">All discovered attributes have been added as rules.</p>
        } @else if (!schemaLoaded()) {
          <p class="schema-hint">Click "Load from Server" to fetch attributes from the SCIM /Schemas endpoint.</p>
        }
      </mat-card-content>
    </mat-card>

    <!-- Editor Panel -->
    @if (editingRule()) {
      <mat-card class="editor-card">
        <mat-card-header>
          <mat-card-title>{{ editingRule()!.id ? 'Edit Rule' : 'New Rule' }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="editor-grid">
            <mat-form-field appearance="outline">
              <mat-label>SCIM Attribute Path</mat-label>
              <input matInput [ngModel]="editingRule()!.scim_attribute"
                (ngModelChange)="editingRule.set({...editingRule()!, scim_attribute: $event})"
                placeholder="userName or emails[0].value">
              <mat-hint>Dot-notation for nested: name.givenName</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Display Name</mat-label>
              <input matInput [ngModel]="editingRule()!.display_name"
                (ngModelChange)="editingRule.set({...editingRule()!, display_name: $event})"
                placeholder="User Name">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Format Validation</mat-label>
              <mat-select [ngModel]="editingRule()!.format"
                (ngModelChange)="editingRule.set({...editingRule()!, format: $event})">
                @for (fmt of formatOptions; track fmt.value) {
                  <mat-option [value]="fmt.value">
                    {{ fmt.label }}
                    <span class="format-desc"> — {{ fmt.description }}</span>
                  </mat-option>
                }
              </mat-select>
              <mat-hint>Choose a format to validate against</mat-hint>
            </mat-form-field>

            @if (editingRule()!.format === 'regex') {
              <mat-form-field appearance="outline">
                <mat-label>Regex Pattern</mat-label>
                <input matInput [ngModel]="editingRule()!.regex_pattern"
                  (ngModelChange)="editingRule.set({...editingRule()!, regex_pattern: $event})"
                  placeholder="^[A-Z]{2,}$">
                <mat-hint>Pattern must match the entire value</mat-hint>
              </mat-form-field>
            }
          </div>

          <div class="editor-row">
            <mat-checkbox [checked]="editingRule()!.required || false"
              (change)="editingRule.set({...editingRule()!, required: $event.checked})">
              Required — must be present in SCIM responses
            </mat-checkbox>
          </div>

          <mat-form-field appearance="outline" class="description-field">
            <mat-label>Notes (optional)</mat-label>
            <textarea matInput rows="2" [ngModel]="editingRule()!.description"
              (ngModelChange)="editingRule.set({...editingRule()!, description: $event})"
              placeholder="e.g., Our IdP requires userName to be email format"></textarea>
          </mat-form-field>

          <div class="editor-actions">
            <button mat-raised-button color="primary" (click)="saveRule()">
              <mat-icon>save</mat-icon> Save Rule
            </button>
            <button mat-button (click)="cancelEdit()">Cancel</button>
          </div>
        </mat-card-content>
      </mat-card>
    }

    <!-- Current Rules Table -->
    <mat-card class="rules-card">
      <mat-card-header>
        <mat-card-title>Active Rules ({{ rules().length }})</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (rules().length > 0) {
          <table mat-table [dataSource]="rules()" class="rules-table">
            <ng-container matColumnDef="scim_attribute">
              <th mat-header-cell *matHeaderCellDef>SCIM Attribute</th>
              <td mat-cell *matCellDef="let rule">
                <code class="attr-path">{{ rule.scim_attribute }}</code>
              </td>
            </ng-container>

            <ng-container matColumnDef="display_name">
              <th mat-header-cell *matHeaderCellDef>Display Name</th>
              <td mat-cell *matCellDef="let rule">{{ rule.display_name }}</td>
            </ng-container>

            <ng-container matColumnDef="required">
              <th mat-header-cell *matHeaderCellDef>Required</th>
              <td mat-cell *matCellDef="let rule">
                @if (rule.required) {
                  <span class="required-badge">Required</span>
                } @else {
                  <span class="optional-badge">Optional</span>
                }
              </td>
            </ng-container>

            <ng-container matColumnDef="format">
              <th mat-header-cell *matHeaderCellDef>Format</th>
              <td mat-cell *matCellDef="let rule">
                <div class="format-cell">
                  <mat-icon class="format-icon">{{ getFormatIcon(rule.format) }}</mat-icon>
                  <span>{{ getFormatLabel(rule.format) }}</span>
                  @if (rule.format === 'regex' && rule.regex_pattern) {
                    <code class="regex-preview" [matTooltip]="rule.regex_pattern">{{ rule.regex_pattern }}</code>
                  }
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let rule">
                <button mat-icon-button (click)="editRule(rule)" matTooltip="Edit rule">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteRule(rule)" matTooltip="Delete rule">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        } @else {
          <div class="empty-rules">
            <mat-icon>rule</mat-icon>
            <p>No field mapping rules yet. Click an attribute above or add a custom one.</p>
            <p class="hint">Rules will be checked during SCIM Validation runs against the selected server.</p>
          </div>
        }
      </mat-card-content>
    </mat-card>
  }
</div>
